CREATE TABLE savings_accounts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    member_id INT NOT NULL,
    account_id INT NOT NULL, -- FK to `accounts` table (e.g., savings account)
    account_number VARCHAR(20) UNIQUE,
    account_type VARCHAR(50), -- optional: "normal", "fixed", etc.
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (member_id) REFERENCES members(id),
    FOREIGN KEY (account_id) REFERENCES accounts(id)
);


CREATE TABLE share_accounts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    member_id INT NOT NULL,
    account_id INT NOT NULL, -- FK to accounts table (e.g., share capital control account)
    shares_owned INT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (member_id) REFERENCES members(id),
    FOREIGN KEY (account_id) REFERENCES accounts(id)
);


CREATE TABLE `tbl_bank` (
  `id` int(11) NOT NULL,
  `transactionReferenceCode` varchar(255) NOT NULL,
  `transactionDate` varchar(255) NOT NULL,
  `totalAmount` varchar(255) NOT NULL,
  `currency` varchar(255) NOT NULL,
  `documentReferenceNumber` varchar(255) NOT NULL,
  `bankCode` varchar(255) NOT NULL,
  `branchCode` varchar(255) NOT NULL,
  `paymentDate` varchar(255) NOT NULL,
  `paymentReferenceCode` varchar(255) NOT NULL,
  `paymentCode` varchar(255) NOT NULL,
  `paymentMode` varchar(255) NOT NULL,
  `paymentAmount` varchar(255) NOT NULL,
  `additionalInfo` text NOT NULL,
  `accountNumber` varchar(255) NOT NULL,
  `accountName` varchar(255) NOT NULL,
  `institutionCode` varchar(255) NOT NULL,
  `institutionName` varchar(255) NOT NULL,
  `created_at` timestamp NOT NULL DEFAULT current_timestamp()
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `tbl_bank`
--

INSERT INTO `tbl_bank` (`id`, `transactionReferenceCode`, `transactionDate`, `totalAmount`, `currency`, `documentReferenceNumber`, `bankCode`, `branchCode`, `paymentDate`, `paymentReferenceCode`, `paymentCode`, `paymentMode`, `paymentAmount`, `additionalInfo`, `accountNumber`, `accountName`, `institutionCode`, `institutionName`, `created_at`) VALUES
(1, 'IB116cd8a1d1b44IDP', '2019-08-28T17:32:02.7460598+03:00', '12', 'KES', 'DOC1234', '45', '01', '2019-08-29', 'PAY1234', 'PC001', 'MPESA', '12', 'Test payment', 'EDA/1140/13', 'John Doe', '2100082', 'Eldoret University', '2025-04-09 19:38:56'),
(2, 'IB116cd8a1d1b44IDP', '2019-08-28T17:32:02.7460598+03:00', '12', 'KES', 'DOC1234', '45', '01', '2019-08-24', 'PAY1234', 'PC001', 'MPESA', '12', 'Test payment', 'EDA/1140/13', 'John Doe', '2100082', 'Eldoret University', '2025-04-11 04:00:26'),
(3, 'SAC001', '2019-08-28T17:32:02.7460598+03:00', '12000', 'KES', 'SAC001', '00011', '00011001', '2019-08-28T17:32:02.7460598+03:00', '', '', '1', '12000', 'SAC001', 'SAC001', '', '', '', '2025-04-11 04:34:21');

--
-- Indexes for dumped tables
--

--
-- Indexes for table `tbl_bank`
--
ALTER TABLE `tbl_bank`
  ADD PRIMARY KEY (`id`);

--
-- AUTO_INCREMENT for dumped tables
--

--
-- AUTO_INCREMENT for table `tbl_bank`
--
ALTER TABLE `tbl_bank`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=4;
COMMIT;


CREATE TABLE loan_types (
    id INT AUTO_INCREMENT PRIMARY KEY,
    loan_name VARCHAR(100) NOT NULL,
    service_charge DECIMAL(5,2) NOT NULL,
    interest_type_id INT, -- FK to a separate table for interest types (optional)
    interest_rate DECIMAL(5,2),
    insurance_premium DECIMAL(5,2),
    crb_amount DECIMAL(10,2),
    min_repayment_period INT,
    max_repayment_period INT,
    min_loan_limit DECIMAL(12,2),
    max_loan_limit DECIMAL(12,2),
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);


CREATE TABLE interest_types (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);



ALTER TABLE loan_types
ADD CONSTRAINT fk_interest_type
FOREIGN KEY (interest_type_id) REFERENCES interest_types(id);

17/04/2025

-- Loan Applications Table
CREATE TABLE loan_applications (
    id INT AUTO_INCREMENT PRIMARY KEY,
    member_id INT NOT NULL,
    loan_type_id INT NOT NULL,
    interest_method VARCHAR(50),
    interest_rate DECIMAL(5,2),
    insurance_premium DECIMAL(5,2),
    crb_amount DECIMAL(10,2),
    service_charge DECIMAL(5,2),
    principal DECIMAL(12,2),
    repayment_period INT,
    request_date DATE,
    total_loan DECIMAL(12,2),
    total_interest DECIMAL(12,2),
    fees DECIMAL(12,2),
    monthly_repayment DECIMAL(12,2),
    disburse_amount DECIMAL(12,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Guarantors Table
CREATE TABLE loan_guarantors (
    id INT AUTO_INCREMENT PRIMARY KEY,
    loan_application_id INT NOT NULL,
    guarantor_member_no VARCHAR(20) NOT NULL,
    name VARCHAR(100),
    mobile VARCHAR(20),
    amount DECIMAL(12,2),
    FOREIGN KEY (loan_application_id) REFERENCES loan_applications(id) ON DELETE CASCADE
);



18/04/2025
ALTER TABLE `loan_applications` ADD `loan_status` ENUM('approved', 'rejected', 'pending') NOT NULL AFTER `disburse_amount`; 



20/04/2025

CREATE TABLE loan_repayments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    loan_id INT NOT NULL,
    installment_number INT NOT NULL,
    due_date DATE NOT NULL,
    amount_due DECIMAL(10,2) NOT NULL,
    amount_paid DECIMAL(10,2) DEFAULT 0.00,
    payment_date DATE DEFAULT NULL,
    status ENUM('pending', 'paid', 'overdue') DEFAULT 'pending',
    payment_method VARCHAR(50) DEFAULT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (loan_id) REFERENCES loan_applications(id)
);


21/04/2025

CREATE TABLE `organization_profile` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `org_name` VARCHAR(255) NOT NULL,
  `phone` VARCHAR(50),
  `email` VARCHAR(100),
  `postal_address` VARCHAR(255),
  `physical_address` VARCHAR(255),
  `logo` VARCHAR(255),
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE `system_parameters` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `param_key` VARCHAR(100) UNIQUE NOT NULL,
  `param_value` TEXT,
  `description` TEXT
);


INSERT INTO system_parameters (param_key, param_value, description)
VALUES
('loan_interest_rate', '0.12', 'Default interest rate for loans'),
('enable_sms_notifications', 'true', 'Toggle SMS alerts'),
('end_of_year_closing', 'manual', 'Manual or automatic closing behavior');

24/4/2025
ALTER TABLE journal_entry_details
DROP FOREIGN KEY journal_entry_details_ibfk_2;


28/04/2025

INSERT INTO system_parameters (param_key, description, param_value) VALUES
('allow_member_self_registration', 'Allow members to register themselves online', 'false'),
('require_approval_for_new_members', 'New member applications require admin approval', 'true'),
('enable_sms_notifications', 'Send SMS notifications for transactions', 'true'),
('enable_email_notifications', 'Send email notifications for transactions', 'true'),
('show_member_balances_on_dashboard', 'Show member balances on their dashboard', 'true'),
('enable_mobile_money_integration', 'Integrate with mobile money services', 'true'),
('allow_member_document_upload', 'Allow members to upload ID, payslips, etc.', 'true'),
('enable_end_of_year_dividends', 'Enable dividend calculation at year-end', 'true'),
('require_beneficiary_for_registration', 'Require member to add a beneficiary when registering', 'true'),
('allow_members_to_view_statements_online', 'Members can view/download their statements', 'true'),
('send_sms_for_savings_deposit', 'Send SMS when a savings deposit is made', 'true'),
('send_sms_for_loan_repayment', 'Send SMS when a loan repayment is made', 'true'),
('enable_admin_email_alerts', 'Send alerts to admin email for key events', 'true'),
('maintenance_mode', 'Put the system into maintenance mode', 'false'),
('maintenance_message', 'Custom message to show during maintenance', 'We are upgrading, please check back soon.'),
('allow_member_password_reset', 'Allow members to reset their passwords', 'true'),
('allow_member_profile_update', 'Allow members to edit their own profile info', 'true'),
('enforce_unique_member_email', 'Require unique email address per member', 'true'),
('enable_member_login', 'Enable or disable member portal login', 'true'),
('show_announcements_on_member_dashboard', 'Show admin announcements on member dashboard', 'true');


ALTER TABLE `users` ADD COLUMN `permissions` TEXT DEFAULT NULL AFTER `role`;


ALTER TABLE `user` CHANGE `role` `role` ENUM('admin','member','user','agent','accountant', 'cashier') CHARACTER SET latin1 COLLATE latin1_swedish_ci NOT NULL; 


new changes

ALTER TABLE `journal_entry_details` CHANGE `transaction_id` `transaction_id` INT(11) NULL;

06/05/2025
ALTER TABLE `savings_accounts` ADD `balance` DECIMAL NOT NULL DEFAULT '0.00' AFTER `account_type`;

13/05/2025
ALTER TABLE transactions
ADD COLUMN reference VARCHAR(64) NOT NULL AFTER description;

ALTER TABLE transactions
ADD UNIQUE (reference);
